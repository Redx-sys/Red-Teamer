---
title: Identify the AWS Account ID from a Public S3 Bucket
date: '2024-10-09'
lastmod: '2024-10-09'
tags: ['AWS', 'Pwned Labs', 'S3', 'Script']
draft: false
summary: 'Este laboratorio se creo con el fin de ense√±ar una t√©cnica que permite encontrar un ID de cuenta de AWS dado un bucket S3 p√∫blico, y aprovecharse de esto.'
images: ['/static/images/pwned_labs']
---

<p align="center">
  ![Portada](https://media.licdn.com/dms/image/v2/D4E10AQHpO-AW2LIJEg/image-shrink_1280/image-shrink_1280/0/1725544363716?e=1729026000&v=beta&t=YE1ksdDq4msultJpDUqS_bMmfVdt--Svj6LGLMom28M)
</p>

<TOCInline toc={props.toc} exclude="Introduccion" />

## Escenario

La capacidad de exponer y aprovechar incluso los descuidos m√°s peque√±os es una habilidad codiciada. Una empresa de log√≠stica global se comunic√≥ con nuestra empresa de ciberseguridad para obtener ayuda y le proporcion√≥ la direcci√≥n IP de su sitio web. ¬øTu objetivo? Inicie la interacci√≥n y utilice esta direcci√≥n IP para identificar su ID de cuenta de AWS a trav√©s de un dep√≥sito p√∫blico de S3 para que podamos comenzar el proceso de enumeraci√≥n.

## Contexto del mundo real

Si los actores de amenazas consiguen un ID de cuenta de AWS, pueden intentar identificar los roles de IAM y los usuarios vinculados a esa cuenta. Pueden hacerlo aprovechando los mensajes de error detallados que devuelven los servicios de AWS al ingresar un nombre de usuario o rol incorrecto. Estos mensajes pueden verificar si existe un usuario o rol de IAM, lo que puede ayudar a los actores de amenazas a compilar una lista de posibles objetivos en la cuenta de AWS. Tambi√©n es posible filtrar instant√°neas p√∫blicas de EBS y RDS por el ID de cuenta de AWS que las posee.

## Tutorial

**IMPORTANTE ANTES DE SEGUIR CON EL TUTORIAL:**  
üí° La bandera en esta pr√°ctica de laboratorio es el ID de la cuenta de AWS asociada con el dep√≥sito S3.

Si quieres probar esta t√©cnica sin leer el tutorial, ¬°si√©ntete libre! Las credenciales de usuario de IAM que necesita se incluyen en la secci√≥n del punto de entrada y el rol que puede asumir se denomina `arn:aws:iam::427648302155:role/LeakyBucket` .

### Enumeracion

Comencemos escaneando la direcci√≥n IP con Nmap. El puerto 80 est√° disponible, podemos comprobarlo en un navegador.
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/1.png)

Esto lo revela el sitio web de la empresa Mega Big Tech. No parece haber ninguna funcionalidad interesante, revisemos el c√≥digo fuente.
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/2.png)

Esto revela que las im√°genes est√°n alojadas en un dep√≥sito de Amazon S3 llamado mega-big-tech.
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/3.png)

La inspecci√≥n de este dep√≥sito en el navegador revela un directorio de im√°genes con otras im√°genes, pero nada demasiado interesante.
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/4.png)

Con el nombre del bucket S3, podemos intentar obtener el ID de la cuenta de AWS en la que est√° alojado. La investigaci√≥n de Ben Bridts revel√≥ que es posible forzar r√°pidamente el ID de la cuenta de AWS a la que pertenece un bucket S3. Se recomienda leer esta publicaci√≥n de investigaci√≥n y tambi√©n revisar el c√≥digo aqu√≠, pero, en resumen, este script crea una pol√≠tica que utiliza la nueva clave de condici√≥n de pol√≠tica S3:ResourceAccount para evaluar si se nos otorga acceso a un bucket S3 en funci√≥n de la cuenta de AWS a la que pertenece el bucket. Afortunadamente, el script no tiene que adivinar un bill√≥n de ID de cuentas diferentes para encontrar el correcto; el espacio de b√∫squeda disponible se reduce significativamente utilizando coincidencia de cadenas y comodines. Cada d√≠gito coincidente se agrega a una variable, y la solicitud se repite hasta que se encuentra el ID de la cuenta.

Le hemos proporcionado al usuario un rol que puede asumir para llevar a cabo este ataque, si no tiene acceso a una cuenta de AWS. Sin embargo, si desea configurar el usuario y la funci√≥n usted mismo, puede crear las pol√≠ticas siguientes.
El usuario de IAM que asuma el rol tendr√≠a adjunta la siguiente pol√≠tica.

```
{
 "Version": "2012-10-17",
 "Statement": {
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::<your aws account id>:role/<your role name>"
  }
}
```

El rol que su usuario puede asumir tendr√≠a adjunta la siguiente pol√≠tica que permite al usuario los permisos de s3:GetObject y s3:ListBucket en el bucket "mega-big-tech".

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Enum",
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::mega-big-tech/*"
        },
        {
            "Sid": "Enum1",
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::mega-big-tech"
        }
    ]
}
```

El rol tambi√©n tendr√≠a configurada la siguiente pol√≠tica de confianza, lo que permitir√≠a al usuario asumir el rol.

![image](https://d2xvzw1rx4uzc3.cloudfront.net/uploads/7fs02wff9zfiohrolgw5amyxsbfwnsn2.png)

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::<your aws account id>:user/s3enum"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

Para el resto de la gu√≠a de laboratorio, usaremos nuestro usuario existente. Primero, configuremos las credenciales proporcionadas usando aws configure. Esto nos permite ejecutar comandos en el contexto del usuario que puede asumir un rol que le asignamos. s3:GetObject y s3:ListBucket permisos para. Es necesario asumir un rol al que se le ha asignado uno de estos permisos para que el script funcione.

```
‚ùØ aws sts get-caller-identity --profile lab

{
    "UserId": "AIDAWHEOTHRF62U7I6AWZ",
    "Account": "427648302155",
    "Arn": "arn:aws:iam::427648302155:user/s3user"
}
```

Luego contin√∫a y emite el comando. pipx install s3-account-search para instalar la herramienta s3-account-search. A continuaci√≥n, debemos proporcionar el nombre de recurso de Amazon (ARN) del rol bajo nuestro control (es decir, en nuestra propia cuenta de AWS), as√≠ como un dep√≥sito S3 de destino en la cuenta de AWS cuyo ID queremos enumerar. Aqu√≠ hemos creado el rol y se lo proporcionamos.

![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/5.jpeg)

Esto revela el ID de la cuenta de AWS. 107513503799. Podemos utilizar esta informaci√≥n para buscar recursos p√∫blicos que el propietario de la cuenta podr√≠a haber expuesto accidentalmente, como instant√°neas p√∫blicas de EBS y RDS.

Primero, ser√≠a bueno saber la regi√≥n de AWS en la que se cre√≥ el dep√≥sito S3, ya que las instant√°neas p√∫blicas est√°n disponibles para todos los usuarios en la misma regi√≥n en la que se cre√≥ la instant√°nea de EBS o RDS. Es probable que si se cre√≥ el dep√≥sito S3 en una regi√≥n espec√≠fica, ¬°otros recursos tambi√©n estar√°n disponibles all√≠!
Para encontrar la regi√≥n del dep√≥sito S3 podemos usar otro truco, esta vez con cURL.

```
curl -I https://mega-big-tech.s3.amazonaws.com
```

![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/6.jpeg)

En los encabezados de respuesta vemos que el encabezado x-amz-bucket-region est√° configurado para us-east-1, que es Virginia del Norte. A continuaci√≥n, inicie sesi√≥n en la consola de administraci√≥n de AWS en su cuenta personal de AWS y aseg√∫rese de que us-east-1 Se selecciona la regi√≥n.
Luego busque el EC2 servicio. Haga clic en el servicio y en el panel de EC2, en el men√∫ de la izquierda, seleccione Snapshots bajo el Elastic Block Store elemento del men√∫. En la lista desplegable, seleccione Public snapshots, pegue el ID de la cuenta de AWS descubierta en el campo y presione Intro/Retorno. Despu√©s de esperar un minuto, recibimos un resultado y vemos que la compa√±√≠a tiene una instant√°nea de EBS expuesta p√∫blicamente
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/7.jpeg)
![image](/static/images/pwned_labs/identify_the_aws_account_id_from_a_public_s3_bucket/8.jpeg)

Aunque los ID de cuentas de AWS no se consideran particularmente confidenciales y, a menudo, los ID de cuentas est√°n disponibles en documentaci√≥n o c√≥digo p√∫blicos, conocer el ID de cuenta de una organizaci√≥n cuya seguridad est√° evaluando podr√≠a resultar √∫til.

En t√©rminos de detecci√≥n, las acciones de STS tienen lugar en la cuenta de la persona que intenta encontrar el ID de la cuenta, que no ser√° visible para la cuenta del propietario del dep√≥sito. Sin embargo, es posible habilitar eventos de datos S3 por un costo adicional.

## Referencias

- [Link al laboratorio](https://pwnedlabs.io/labs/identify-the-aws-account-id-from-a-public-s3-bucket)
- [Link 1](https://aws.amazon.com/blogs/storage/limit-access-to-amazon-s3-buckets-owned-by-specific-aws-accounts/)
- [Link 2](https://github.com/WeAreCloudar/s3-account-search)
- [Link 3](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)
