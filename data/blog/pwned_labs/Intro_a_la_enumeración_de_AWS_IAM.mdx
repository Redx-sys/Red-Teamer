---
title: Intro a la enumeracion de AWS IAM
date: '2024-10-12'
lastmod: '2024-10-12'
tags: ['AWS', 'Pwned Labs', 'IAM']
draft: true
summary: 'Este laboratorio apto para principiantes brinda una introducci√≥n a la CLI de AWS, as√≠ como a la enumeraci√≥n de pol√≠ticas, grupos, roles y usuarios de IAM. '
images: ['/static/images/pwned_labs']
---

<p align="center">
  ![Portada](https://media.licdn.com/dms/image/D4E22AQGIdxBn84Fl3A/feedshare-shrink_800/0/1698754010174?e=2147483647&v=beta&t=3C-eR1XrabzMAqYEZsH6_FMlIwrAdKHsAY7nJWXN7eg)
</p>

<TOCInline toc={props.toc} exclude="Introduccion" />

## Escenario

Usted es un consultor de seguridad contratado por la empresa de log√≠stica global Huge Logistics.
Despu√©s de una actividad sospechosa, usted tiene la tarea de enumerar el usuario de IAM. dev01 y
mapear cualquier recurso potencialmente comprometido. Su misi√≥n es enumerar y evaluar roles, pol√≠ticas y permisos de IAM.

## Contexto del mundo real

IAM (Identity and Access Managment) es fundamental para crear, defender y atacar los servicios en la nube.
Tanto los profesionales de la seguridad ofensiva como la defensiva necesitan una s√≥lida comprensi√≥n de IAM y
de c√≥mo enumerar los permisos: los atacantes buscan configuraciones excesivamente permisivas o configuraciones
err√≥neas en una posible cadena de ataque, mientras que los defensores se aseguran de la necesidad de
hacer cumplir el principio de privilegio m√≠nimo e identificar cualquier recurso o servicio
que se encuentran en el radio de explosi√≥n de un usuario de IAM comprometido.

## Tutorial

#### ¬øC√≥mo podemos interactuar con AWS?

¬°Hay muchas formas de interactuar con AWS! En esta pr√°ctica de laboratorio, aprenderemos a utilizar la Consola de administraci√≥n de AWS y la CLI de AWS.

- `AWS Managment Console` : una interfaz web que proporciona una forma gr√°fica de administrar los recursos de AWS.
- `AWS CLI` : la interfaz de l√≠nea de comandos le permite administrar los servicios de AWS a trav√©s de la l√≠nea de comandos.
- `SDK` : los kits de desarrollo de software est√°n disponibles en varios lenguajes como Python (Boto3), Java, .NET y m√°s, lo que permite el acceso program√°tico a los servicios de AWS.
- `API` : la mayor√≠a de los servicios de AWS exponen API RESTful con las que puede interactuar directamente.

La URL de la Consola de administraci√≥n de AWS para usuarios de IAM se parece al ejemplo siguiente.
Nuestro ID de cuenta de AWS 794929857501 forma parte de la URL y AWS la utiliza para completar autom√°ticamente
el campo ID de cuenta de la p√°gina de inicio de sesi√≥n del usuario de IAM.
Contin√∫e, haga clic en el enlace e inicie sesi√≥n con las credenciales de usuario de AWS IAM proporcionadas.

![image](/static/images/pwned_labs/intro_aws_iam_enum/1.png)

Al iniciar sesi√≥n, vemos una colecci√≥n de servicios visitados recientemente. Haciendo clic en `Services` en la esquina superior
izquierda de la ventana podemos hacer clic en `All services` y despl√°cese por una lista alfab√©tica de servicios.

![image](/static/images/pwned_labs/intro_aws_iam_enum/2.png)

La consola de AWS ofrece una manera conveniente de acceder, crear, modificar y eliminar recursos.

Haga clic en GuardDutyservicio arriba, en la lista alfab√©tica o √°bralo despu√©s de buscar el servicio.
En la consola de GuardDuty que se abre, seleccione la regi√≥n us-west-1 de la lista desplegable y ¬°comience a explorar! üòé

![image](/static/images/pwned_labs/intro_aws_iam_enum/3.png)

## AWS CLI

Aunque la Consola de Administraci√≥n de AWS es muy conveniente, la AWS CLI es muy poderosa y nos permite procesar comandos en
lote y llevar a cabo automatizaciones, facilitando nuestras tareas.

Este laboratorio se centrar√° en la AWS CLI, ya que buscamos identificar el radio de impacto del usuario IAM potencialmente
comprometido y lo que podr√≠a haber accedido.

La AWS CLI se puede instalar utilizando el siguiente comando para Debian / Ubuntu. Para otros sistemas operativos y distribuciones,
puedes consultar la documentaci√≥n de AWS [aqu√≠](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html).

```
sudo apt install awscli
```

En la CLI de AWS, nos autenticamos mediante la AWS Access Key y Secret Key. ¬øCu√°les son?

La clave de acceso y la clave de acceso secreta juntas forman un conjunto de credenciales que se utilizan para
autenticar solicitudes de API y funcionan como una especie de "nombre de usuario y contrase√±a".
Estas claves se generan a trav√©s de la Consola de administraci√≥n de AWS y est√°n vinculadas a un usuario de
IAM o una cuenta ra√≠z de AWS.

1. `Access Key ID`: Es una cadena alfanum√©rica de 20 caracteres (por ejemplo, "AKIAIOSFODNN7EXAMPLE").
   Se utiliza para identificar al usuario o la cuenta que realiza una solicitud program√°tica a un servicio de AWS. Est√° destinado a ser compartido, como un nombre de usuario.
2. `Secret Access Key`: Es una cadena de 40 caracteres (por ejemplo, "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY") y sirve como "contrase√±a" para autenticar las solicitudes
   realizadas con el ID de clave de acceso correspondiente. A diferencia del ID de la clave de acceso, la clave de acceso secreta es confidencial y nunca debe compartirse
   ni almacenarse de manera insegura.

Las claves de AWS que usaremos para el resto de nuestra investigaci√≥n se encuentran a continuaci√≥n.

```
Access key ID
AKIA3SFMDAPOWCEXAMPLE

Secret access key
+hCgg8uYwGeedSpfARQyGFkr9fdVhnrObexample
```

Podemos configurar las claves con el comando AWS CLI aws configure, como se muestra a continuaci√≥n.

```
aws configure --profile lab
```

![image](/static/images/pwned_labs/intro_aws_iam_enum/4.png)

Una vez configuradas las claves podremos interactuar con AWS en el contexto de ejecuci√≥n de este usuario.

El siguiente comando puede considerarse un poco como el comando whoami en Windows y Linux.
Como era de esperar, esto revela que estamos en el contexto del usuario de IAM llamado `dev01` en la cuenta de AWS `794929857501`.

```
> aws sts get-caller-identity --profile lab
{
    "UserId": "AIDA3SFMDAPOWFB7BSGME",
    "Account": "794929857501",
    "Arn": "arn:aws:iam::794929857501:user/dev01"
}
```

Obtengamos m√°s informaci√≥n sobre nuestro usuario potencialmente comprometido, `dev01`.

```
> aws iam get-user --profile lab

{
    "User": {
        "Path": "/",
        "UserName": "dev01",
        "UserId": "AIDA3SFMDAPOWFB7BSGME",
        "Arn": "arn:aws:iam::794929857501:user/dev01",
        "CreateDate": "2023-09-28T21:56:31+00:00",
        "PasswordLastUsed": "2024-10-12T13:21:05+00:00",
        "Tags": [
            {
                "Key": "AKIA3SFMDAPOWEXAMPLE",
                "Value": "dev01"
            }
        ]
    }
}
```

Esto tambi√©n proporciona la fecha en que se cre√≥ el usuario de IAM y la etiqueta. Una etiqueta es un par clave-valor que puede adjuntar a los recursos de AWS, incluidos los usuarios de IAM. Las etiquetas facilitan la gesti√≥n, la b√∫squeda y el filtrado de recursos.

Tambi√©n podemos emitir el siguiente comando para enumerar cualquier grupo del que podamos ser miembros. Un grupo de usuarios es una colecci√≥n de usuarios de IAM que permite a varios usuarios heredar los permisos que se le atribuyen. Descubrimos que el usuario de IAM no es miembro de ning√∫n grupo.

```
> aws iam list-groups-for-user --user-name dev01 --profile lab

{
    "Groups": []
}
```

## Listar pol√≠ticas de usuario adjuntas

En su lugar, podemos intentar enumerar las pol√≠ticas de usuario adjuntas.

```
> aws iam list-attached-user-policies --user-name dev01 --profile lab

{
    "AttachedPolicies": [
        {
            "PolicyName": "AmazonGuardDutyReadOnlyAccess",
            "PolicyArn": "arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess"
        },
        {
            "PolicyName": "dev01",
            "PolicyArn": "arn:aws:iam::794929857501:policy/dev01"
        }
    ]
}
```

Parece que tenemos permisos para enumerarlos, y esto revela que la pol√≠tica administrada de Amazon
AmazonGuardDutyReadOnlyAccess y una pol√≠tica administrada por el cliente denominada dev01 se han adjuntado
a nuestro usuario de IAM. GuardDuty es un servicio de detecci√≥n de amenazas que monitorea continuamente
comportamientos maliciosos o no autorizados para ayudar a proteger sus cuentas y cargas de trabajo de AWS.
El PolicyArn se refiere al nombre del recurso de Amazon, que es una combinaci√≥n del ID de la cuenta de AWS,
el tipo de recurso y el nombre del recurso. El ARN es una referencia global √∫nica al objeto.

## Listar pol√≠ticas en l√≠nea

A continuaci√≥n, verifiquemos las pol√≠ticas en l√≠nea. Una pol√≠tica en l√≠nea en AWS IAM
es una pol√≠tica que est√° integrada directamente en un √∫nico usuario,
grupo o rol de IAM y no se administra ni se puede reutilizar por separado.

```
> aws iam list-user-policies --user-name dev01 --profile lab

{
    "PolicyNames": [
        "S3_Access"
    ]
}
```

Esto revela una interesante pol√≠tica en l√≠nea llamada S3_Access . ¬°Veamos, examinemos las pol√≠ticas y veamos qu√© permisos tenemos!

## Profundizando en las pol√≠ticas

Primero enumeramos las versiones de la pol√≠tica AmazonGuardDutyReadOnlyAccess. Las pol√≠ticas administradas por Amazon y por el cliente
pueden tener varias versiones, lo que le permite conservar, revisar y revertir a versiones de pol√≠ticas anteriores.
Las pol√≠ticas en l√≠nea no admiten el control de versiones.

```
aws iam list-policy-versions --policy-arn arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess --profile lab

{
    "Versions": [
        {
            "VersionId": "v4",
            "IsDefaultVersion": true,
            "CreateDate": "2023-11-16T23:07:06+00:00"
        },
        {
            "VersionId": "v3",
            "IsDefaultVersion": false,
            "CreateDate": "2021-02-16T23:37:57+00:00"
        },
        {
            "VersionId": "v2",
            "IsDefaultVersion": false,
            "CreateDate": "2018-04-25T21:07:17+00:00"
        },
        {
            "VersionId": "v1",
            "IsDefaultVersion": false,
            "CreateDate": "2017-11-28T22:29:40+00:00"
        }
    ]
}
```

La √∫ltima versi√≥n es la v4. Al ejecutar el siguiente comando, vemos que todas las acciones Describe, Get y List est√°n permitidas.

```
aws iam get-policy-version --policy-arn arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess --version-id v4 --profile lab

{
    "PolicyVersion": {
        "Document": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": [
                        "guardduty:Describe*",
                        "guardduty:Get*",
                        "guardduty:List*"
                    ],
                    "Resource": "*"
                },
                {
                    "Effect": "Allow",
                    "Action": [
                        "organizations:ListDelegatedAdministrators",
                        "organizations:ListAWSServiceAccessForOrganization",
                        "organizations:DescribeOrganizationalUnit",
                        "organizations:DescribeAccount",
                        "organizations:DescribeOrganization",
                        "organizations:ListAccounts"
                    ],
                    "Resource": "*"
                }
            ]
        },
        "VersionId": "v4",
        "IsDefaultVersion": true,
        "CreateDate": "2023-11-16T23:07:06+00:00"
    }
}
```

Describe nos permite recuperar detalles sobre los recursos de GuardDuty.
Se permitir√° cualquier cosa que comience con "Describie" en las operaciones de la API de GuardDuty,
como describir detectores, hallazgos o configuraciones. Get nos permite obtener hallazgos,
conjuntos de informaci√≥n sobre amenazas o filtrar detalles, mientras que List permite enumerar
detectores, miembros o hallazgos. Generalmente se utiliza para obtener una lista de recursos pero no su informaci√≥n detallada.

A continuaci√≥n, enumeramos las versiones de la pol√≠tica administrada por el
cliente denominada dev01 y ver que la √∫ltima versi√≥n es v7.

```
aws iam list-policy-versions --policy-arn arn:aws:iam::794929857501:policy/dev01 --profile lab

{
    "Versions": [
        {
            "VersionId": "v7",
            "IsDefaultVersion": true,
            "CreateDate": "2023-10-11T19:59:08+00:00"
        },
        {
            "VersionId": "v6",
            "IsDefaultVersion": false,
            "CreateDate": "2023-10-11T19:47:41+00:00"
        },
        {
            "VersionId": "v5",
            "IsDefaultVersion": false,
            "CreateDate": "2023-10-07T22:48:28+00:00"
        },
        {
            "VersionId": "v4",
            "IsDefaultVersion": false,
            "CreateDate": "2023-10-02T20:38:35+00:00"
        },
        {
            "VersionId": "v3",
            "IsDefaultVersion": false,
            "CreateDate": "2023-10-02T20:29:52+00:00"
        }
    ]
}
```

Obtengamos tambi√©n el documento JSON para esta pol√≠tica.
Esto muestra varias acciones permitidas que se aplican a un usuario, rol y pol√≠ticas en el Resources secci√≥n.

```
aws iam get-policy-version --policy-arn arn:aws:iam::794929857501:policy/dev01 --version-id v7 --profile lab

{
    "PolicyVersion": {
        "Document": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Sid": "VisualEditor0",
                    "Effect": "Allow",
                    "Action": [
                        "iam:GetRole",
                        "iam:GetPolicyVersion",
                        "iam:GetPolicy",
                        "iam:ListPolicyVersions",
                        "iam:GetUserPolicy",
                        "iam:ListGroupsForUser",
                        "iam:ListAttachedUserPolicies",
                        "iam:ListUserPolicies",
                        "iam:GetUser",
                        "iam:ListAttachedRolePolicies",
                        "iam:GetRolePolicy"
                    ],
                    "Resource": [
                        "arn:aws:iam::794929857501:user/dev01",
                        "arn:aws:iam::794929857501:role/BackendDev",
                        "arn:aws:iam::794929857501:policy/BackendDevPolicy",
                        "arn:aws:iam::794929857501:policy/dev01",
                        "arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess"
                    ]
                }
            ]
        },
        "VersionId": "v7",
        "IsDefaultVersion": true,
        "CreateDate": "2023-10-11T19:59:08+00:00"
    }
}
```

Podemos trazar las acciones permitidas seg√∫n se aplican a los diversos recursos
contenidos en el Resource secci√≥n del documento JSON:

1. IAM User (`arn:aws:iam::794929857501:user/dev01`):

- `iam:GetUser`
- `iam:ListAttachedUserPolicies`
- `iam:ListUserPolicies`
- `iam:GetUserPolicy`
- `iam:ListGroupsForUser`

2. IAM Role (`arn:aws:iam::794929857501:role/BackendDev`):

- `iam:GetRole`
- `iam:GetRolePolicy`
- `iam:ListAttachedRolePolicies`

3. Customer Managed Role Policy (`arn:aws:iam::794929857501:policy/BackendDevPolicy`):

- `iam:GetPolicy`
- `iam:GetPolicyVersion`
- `iam:ListPolicyVersions`

4. Customer Managed Policy (`arn:aws:iam::794929857501:policy/dev01`):

- `iam:GetPolicy`
- `iam:GetPolicyVersion`
- `iam:ListPolicyVersions`

5. Amazon Managed Policy (`arn:aws:iam::aws:policy/AmazonGuardDutyReadOnlyAccess`):

- `iam:GetPolicy`
- `iam:GetPolicyVersion`
- `iam:ListPolicyVersions`

Esta p√≥liza administrada por el cliente adjunta al usuario `dev01` IAM otorgandole permisos para obtener detalles sobre s√≠ mismo,
cualquier grupo del que sea miembro y su pol√≠tica adjunta.
Tambi√©n les otorga permiso para obtener detalles sobre la funci√≥n BackendDev, enumerar las pol√≠ticas adjuntas a la funci√≥n y obtener
informaci√≥n sobre una pol√≠tica denominada BackendDevPolicy que asumimos est√° adscrito al rol.
Tambi√©n nos permite obtener informaci√≥n sobre una pol√≠tica administrada por Amazon.

Confirmemos nuestra suposici√≥n sobre BackendDev y BackendDevPolicy.

```
aws iam list-attached-role-policies --role-name BackendDev --profile lab

{
    "AttachedPolicies": [
        {
            "PolicyName": "BackendDevPolicy",
            "PolicyArn": "arn:aws:iam::794929857501:policy/BackendDevPolicy"
        }
    ]
}
```

Sigamos enumerando los BackEnd rol y BackendDevPolicy pol√≠tica (ARN enumerados a continuaci√≥n).

```
arn:aws:iam::794929857501:role/BackendDev
arn:aws:iam::794929857501:policy/BackendDevPolicy
```

Podemos usar el get-role Iam acci√≥n para obtener informaci√≥n sobre el rol.
Esto revela que el prop√≥sito del rol es permitir que los desarrolladores lo asuman.
Asumir un papel puede considerarse un poco como el sudo comando en Linux,
ya que proporciona credenciales temporales que nos permiten actuar en el contexto de privilegio del rol.
Actualmente solo el usuario de IAM dev01 se le permite asumir el rol.

```
aws iam get-role --role-name BackendDev --profile lab

{
    "Role": {
        "Path": "/",
        "RoleName": "BackendDev",
        "RoleId": "AROA3SFMDAPO2RZ36QVN6",
        "Arn": "arn:aws:iam::794929857501:role/BackendDev",
        "CreateDate": "2023-09-29T12:30:29+00:00",
        "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "AWS": "arn:aws:iam::794929857501:user/dev01"
                    },
                    "Action": "sts:AssumeRole"
                }
            ]
        },
        "Description": "Grant permissions to backend developers",
        "MaxSessionDuration": 3600,
        "RoleLastUsed": {
            "LastUsedDate": "2024-10-12T08:42:08+00:00",
            "Region": "us-east-1"
        }
    }
}
```

Continuemos nuestra investigaci√≥n y enumeremos la pol√≠tica.
La acci√≥n `get-policy` revela que la versi√≥n actual de la pol√≠tica es v1.

```
aws iam get-policy --policy-arn arn:aws:iam::794929857501:policy/BackendDevPolicy --profile lab

{
    "Policy": {
        "PolicyName": "BackendDevPolicy",
        "PolicyId": "ANPA3SFMDAPO7OINIQIRR",
        "Arn": "arn:aws:iam::794929857501:policy/BackendDevPolicy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 1,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "Description": "Policy defining permissions for backend developers",
        "CreateDate": "2023-09-29T12:44:09+00:00",
        "UpdateDate": "2023-09-29T12:44:09+00:00",
        "Tags": []
    }
}
```

Podemos usar `get-policy-version` para recuperar el documento de pol√≠tica JSON asociado con esta versi√≥n (actualmente la √∫nica versi√≥n).
Si asumimos el rol, podremos recuperar informaci√≥n sobre todas las instancias EC2 en la cuenta de AWS y enumerar todos los secretos
almacenados actualmente en SecretsManager. Tambi√©n podremos obtener informaci√≥n sobre (describir) y recuperar el valor secreto de prod/Customers !

```
aws iam get-policy-version --policy-arn arn:aws:iam::794929857501:policy/BackendDevPolicy --version-id v1 --profile lab

{
    "PolicyVersion": {
        "Document": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Sid": "VisualEditor0",
                    "Effect": "Allow",
                    "Action": [
                        "ec2:DescribeInstances",
                        "secretsmanager:ListSecrets"
                    ],
                    "Resource": "*"
                },
                {
                    "Sid": "VisualEditor1",
                    "Effect": "Allow",
                    "Action": [
                        "secretsmanager:GetSecretValue",
                        "secretsmanager:DescribeSecret"
                    ],
                    "Resource": "arn:aws:secretsmanager:us-east-1:794929857501:secret:prod/Customers-QUhpZf"
                }
            ]
        },
        "VersionId": "v1",
        "IsDefaultVersion": true,
        "CreateDate": "2023-09-29T12:44:09+00:00"
    }
}
```

Finalmente, examinemos la pol√≠tica de usuario en l√≠nea con el get-user-policy acci√≥n.
Esto muestra que podemos enumerar y recuperar cualquier contenido en el dep√≥sito S3 potencialmente confidencial llamado hl-dev-artifacts.

```
aws iam get-user-policy --user-name dev01 --policy-name S3_Access --profile lab

{
    "UserName": "dev01",
    "PolicyName": "S3_Access",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:ListBucket",
                    "s3:GetObject"
                ],
                "Resource": [
                    "arn:aws:s3:::hl-dev-artifacts",
                    "arn:aws:s3:::hl-dev-artifacts/*"
                ]
            }
        ]
    }
}
```

Tracemos visualmente a qu√© podr√≠a acceder alguien que use esta cuenta potencialmente comprometida.

![imagen](https://s3.amazonaws.com/useast1-images-pwnedlabs.io/uploads/xbdloltcbv5hkjhwuyrfppd09ayehgio.png)

```
‚ùØ aws s3 ls s3://hl-dev-artifacts --profile lab
2023-10-01 17:39:53       1235 android-kotlin-extensions-tooling-232.9921.47.pom
2023-10-01 17:39:53     214036 android-project-system-gradle-models-232.9921.47-sources.jar
2023-10-01 17:38:05         32 flag.txt
```

## Referencias

- [Link al laboratorio](https://pwnedlabs.io/labs/intro-to-aws-iam-enumeration)
- [Docs AWS IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
